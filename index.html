<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="manifest" href="manifest.json">
<title>ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ˜ãƒªæ´»å‹•è¨˜éŒ² v3.8 (2025/12/28 14:15)</title>
<style>
:root{
  --ink:#111827;--muted:#6b7280;--bg:#f2f2f7;--card:#fff;
  --line:#c6c6c8;--brand:#007aff;--chip:#f2f2f7;
  --safe-top:env(safe-area-inset-top);
  --safe-bottom:env(safe-area-inset-bottom);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;overscroll-behavior:none}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  color:var(--ink);background:var(--bg);
  padding-bottom:calc(60px + var(--safe-bottom));
}
header{
  position:sticky;top:0;z-index:100;
  background:rgba(242,242,247,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:0.5px solid var(--line);
  padding:calc(12px + var(--safe-top)) 16px 12px;
}
h1{margin:0;font-size:17px;font-weight:600;text-align:center}
.sub{margin:4px 0 0;color:var(--muted);font-size:12px;text-align:center}
main{padding:12px}
.card{
  background:#fff;border-radius:12px;
  margin-bottom:12px;overflow:hidden;
}
.card-header{
  padding:14px 16px 10px;
  font-size:15px;font-weight:600;
  border-bottom:0.5px solid var(--line);
}
.card-body{padding:12px 16px}
h3{margin:12px 0 8px;font-size:13px;color:var(--muted);font-weight:500}
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 4px}
input,textarea,select{
  width:100%;padding:12px;
  border:none;border-radius:10px;
  background:var(--chip);font-size:16px;
  -webkit-appearance:none;
}
textarea{resize:none;min-height:80px}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.time-row{display:flex;gap:8px;align-items:center}
.time-row input{flex:1}
.time-btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:8px;
  padding:12px 14px;font-size:14px;font-weight:500;
  white-space:nowrap;
}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.chip{
  background:var(--chip);border:1.5px solid transparent;
  border-radius:20px;padding:8px 14px;
  font-size:14px;font-weight:500;
  user-select:none;cursor:pointer;
  transition:all 0.15s;
}
.chip:active{transform:scale(0.95)}
.chip[data-state="on"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="+"]{background:#fee2e2;border-color:#f87171;color:#b91c1c}
.chip[data-state="-"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="proc"]{background:var(--brand);color:#fff}
.btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:10px;
  padding:14px 20px;font-size:15px;font-weight:600;
  width:100%;
}
.btn:active{opacity:0.8}
.btn.ghost{background:var(--chip);color:var(--ink)}
.btn.small{padding:10px 16px;font-size:14px}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-row .btn{flex:1}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
.toggle-btn{
  background:var(--chip);
  border:1.5px solid var(--line);
  border-radius:10px;
  padding:10px 16px;
  font-size:15px;font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
  user-select:none;
}
.toggle-btn:active{transform:scale(0.97)}
.toggle-btn.active{
  background:#dcfce7;
  border-color:#4ade80;
  color:#15803d;
}

/* å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
@keyframes checkFlash {
  0% { background: transparent; }
  50% { background: rgba(0, 122, 255, 0.15); }
  100% { background: transparent; }
}
.check-flash {
  animation: checkFlash 0.4s ease-out;
  border-radius: 8px;
}

/* ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ */
.vital-card{
  background:#fff;border-radius:12px;
  margin-top:10px;overflow:hidden;
  border:1px solid var(--line);
}
.vital-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 14px;background:#f9fafb;
  border-bottom:0.5px solid var(--line);
}
.vital-time{
  display:flex;align-items:center;gap:8px;
}
.vital-time input{
  width:100px;padding:8px 10px;
  font-size:15px;font-weight:600;
  color:var(--brand);background:#fff;
  border:1px solid var(--line);border-radius:8px;
}
.vital-del{
  background:#fee2e2;color:#dc2626;
  border:none;border-radius:8px;
  padding:8px 12px;font-size:13px;font-weight:500;
}
.vital-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:1px;background:var(--line);
}
.vital-item{
  background:#fff;padding:10px 8px;
  text-align:center;cursor:pointer;
  transition:background 0.15s;
}
.vital-item:active{background:#f3f4f6}
.vital-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.vital-value{font-size:20px;font-weight:600;color:var(--ink)}
.vital-unit{font-size:11px;color:var(--muted)}
.vital-gcs{
  grid-column:span 3;
  display:flex;justify-content:center;gap:20px;
  padding:12px;
}
.gcs-part{text-align:center;cursor:pointer}
.gcs-part span{display:block}
.gcs-part .lbl{font-size:12px;color:var(--muted)}
.gcs-part .val{font-size:22px;font-weight:600;color:var(--brand)}
.gcs-sum{
  background:var(--brand);color:#fff;
  border-radius:20px;padding:6px 16px;
  font-size:16px;font-weight:600;
  align-self:center;
}

/* ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ */
.dial-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.4);
  z-index:1000;display:none;
  align-items:flex-end;justify-content:center;
  touch-action:none;
  overscroll-behavior:contain;
}
.dial-overlay.show{display:flex}
body.dial-open{overflow:hidden;position:fixed;width:100%;}
.dial-container{
  background:#fff;
  border-radius:16px 16px 0 0;
  width:100%;max-width:500px;
  padding-bottom:var(--safe-bottom);
  animation:slideUp 0.25s ease-out;
}
@keyframes slideUp{from{transform:translateY(100%)}}
.dial-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 20px;border-bottom:0.5px solid var(--line);
}
.dial-title{font-size:17px;font-weight:600}
.dial-done{
  background:none;border:none;
  color:var(--brand);font-size:17px;font-weight:600;
}
.dial-body{
  display:flex;justify-content:center;
  padding:20px;gap:10px;
}
.dial-wheel{
  height:200px;width:120px;
  overflow:hidden;position:relative;
  touch-action:pan-y;
}
.dial-wheel::before,.dial-wheel::after{
  content:'';position:absolute;left:0;right:0;
  height:80px;pointer-events:none;z-index:2;
}
.dial-wheel::before{
  top:0;
  background:linear-gradient(to bottom,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-wheel::after{
  bottom:0;
  background:linear-gradient(to top,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-highlight{
  position:absolute;top:50%;left:0;right:0;
  height:40px;transform:translateY(-50%);
  background:var(--chip);border-radius:8px;
  z-index:1;
}
.dial-scroll{
  position:relative;z-index:3;
  padding:80px 0;
  transition:transform 0.15s ease-out;
}
.dial-option{
  height:40px;display:flex;
  align-items:center;justify-content:center;
  font-size:18px;font-weight:500;
  color:#999;
  transition:all 0.15s;
}
.dial-option.selected{
  color:var(--ink);font-weight:600;
  font-size:22px;
}
.dial-unit{
  font-size:14px;color:var(--muted);
  align-self:center;
}

/* æ‰€è¦‹ã‚¿ãƒ– */
.exam-tabs{
  display:flex;gap:8px;overflow-x:auto;
  padding:0 0 10px;margin:0 -16px;padding-left:16px;
  -webkit-overflow-scrolling:touch;
}
.exam-tabs::-webkit-scrollbar{display:none}
.exam-tab{
  flex-shrink:0;
  padding:10px 16px;border-radius:20px;
  background:var(--chip);font-size:14px;font-weight:500;
  cursor:pointer;
}
.exam-tab.active{background:var(--brand);color:#fff}
.exam-pane{display:none}
.exam-pane.active{display:block}
.memo{
  margin-top:8px;background:var(--chip);
  border-radius:10px;padding:12px;
  font-size:14px;min-height:60px;
}

/* å‡ºåŠ›ã‚¨ãƒªã‚¢ */
.result{
  white-space:pre-wrap;
  background:#fafafa;border-radius:12px;
  padding:14px;font-size:13px;line-height:1.7;
  min-height:300px;
  border:1px dashed var(--line);
}

/* ä¸‹éƒ¨ãƒŠãƒ“ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(255,255,255,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:0.5px solid var(--line);
  padding:10px 16px calc(10px + var(--safe-bottom));
  display:flex;gap:10px;z-index:100;
}
.bottom-nav .btn{flex:1;padding:12px}

/* ç—…é™¢ãƒªã‚¹ãƒˆ */
.hospital-item{
  display:flex;justify-content:space-between;
  align-items:center;padding:12px 0;
  border-bottom:0.5px solid var(--line);
}
.hospital-item:last-child{border-bottom:none}

/* ãƒã‚§ãƒƒã‚¯ãƒ©ã‚¤ãƒ³ */
.checkline{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
.checkline label{
  display:flex;align-items:center;gap:6px;
  font-size:14px;margin:0;
}
.checkline input[type="checkbox"]{
  width:22px;height:22px;
  accent-color:var(--brand);
}

/* ãƒ©ãƒœãƒ”ãƒ« */
.labline{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.labpill{
  display:flex;align-items:center;gap:6px;
  background:var(--chip);border-radius:20px;
  padding:8px 12px;
}
.labpill label{margin:0;font-size:13px;font-weight:500}
.labpill input{
  width:70px;padding:6px 8px;
  background:#fff;border:1px solid var(--line);
  border-radius:6px;font-size:14px;
}
.labpill .unit{font-size:12px;color:var(--muted)}
.labpill button{
  background:none;border:none;
  font-size:16px;color:#dc2626;padding:0 4px;
}

/* å•é¡Œãƒªã‚¹ãƒˆ */
.problem-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  background:var(--chip);
  border-radius:10px;
  margin-bottom:8px;
}
.problem-item span{
  font-size:14px;
  flex:1;
  min-width:0;
}
.problem-item .del-btn{
  margin-left:12px;
  flex-shrink:0;
  padding:6px 12px;
  font-size:13px;
  background:none;
  border:1px solid #dc2626;
  color:#dc2626;
  border-radius:6px;
}

/* NIHSSãƒœã‚¿ãƒ³ */
.nihss-btn{
  min-width:36px;height:36px;
  border:1px solid var(--line);border-radius:8px;
  background:#fff;font-size:15px;font-weight:500;
  cursor:pointer;
}
.nihss-btn.active{
  background:var(--brand);color:#fff;border-color:var(--brand);
}
</style>
</head>
<body>
<header>
  <h1>ğŸš ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ˜ãƒªæ´»å‹•è¨˜éŒ²</h1>
  <p class="sub">heli record v3.8</p>
</header>

<main>
  <div class="card">
    <div class="card-header">ğŸ“ è¦è«‹æƒ…å ±</div>
    <div class="card-body">
      <label>è¦è«‹æ–¹æ³•</label>
      <select id="request_type">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹</option>
        <option value="ç¾ç€å¾Œè¦è«‹">ç¾ç€å¾Œè¦è«‹</option>
        <option value="æ–½è¨­é–“æ¬é€">æ–½è¨­é–“æ¬é€</option>
        <option value="ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒªãƒãƒªãƒ¼">ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒªãƒãƒªãƒ¼</option>
      </select>
      <label>è¦è«‹å†…å®¹</label>
      <textarea id="request_detail" placeholder="è¦è«‹ã®è©³ç´°å†…å®¹ã‚’è¨˜è¼‰"></textarea>
      
      <h3>æ‚£è€…æƒ…å ±</h3>
      <label>æ—¢å¾€æ­´</label>
      <textarea id="patient_history" placeholder="æ—¢å¾€æ­´ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>å¸¸ç”¨è–¬</label>
      <textarea id="patient_medication" placeholder="å¸¸ç”¨è–¬ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
      <textarea id="patient_allergy" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>æœ€çµ‚é£Ÿäº‹æ™‚åˆ»</label>
      <div class="time-row">
        <input type="time" id="last_meal_time">
        <button class="time-btn" onclick="setNow('last_meal_time')">Now</button>
      </div>
      <label>ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢</label>
      <textarea id="patient_hospital" placeholder="ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="card-header">â±ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    <div class="card-body">
      <div class="grid2">
        <div>
          <label>è¦è«‹</label>
          <div class="time-row">
            <input type="time" id="request_time">
            <button class="time-btn" onclick="setNow('request_time')">Now</button>
          </div>
        </div>
        <div>
          <label>ãƒ˜ãƒªé›¢é™¸</label>
          <div class="time-row">
            <input type="time" id="heli_takeoff">
            <button class="time-btn" onclick="setNow('heli_takeoff')">Now</button>
          </div>
        </div>
        <div>
          <label>LZç€é™¸</label>
          <div class="time-row">
            <input type="time" id="heli_lz_landing">
            <button class="time-btn" onclick="setNow('heli_lz_landing')">Now</button>
          </div>
        </div>
        <div>
          <label>FDæ¥è§¦</label>
          <div class="time-row">
            <input type="time" id="fd_contact">
            <button class="time-btn" onclick="setNow('fd_contact')">Now</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ğŸš‘ å…ˆè¡Œæ•‘æ€¥éšŠ</div>
    <div class="card-body">
      <div class="grid2">
        <div>
          <label>è¦šçŸ¥</label>
          <div class="time-row">
            <input type="time" id="ems_aware">
            <button class="time-btn" onclick="setNow('ems_aware')">Now</button>
          </div>
        </div>
        <div>
          <label>ç¾ç€</label>
          <div class="time-row">
            <input type="time" id="ems_arrival">
            <button class="time-btn" onclick="setNow('ems_arrival')">Now</button>
          </div>
        </div>
        <div>
          <label>æ¥è§¦</label>
          <div class="time-row">
            <input type="time" id="ems_contact">
            <button class="time-btn" onclick="setNow('ems_contact')">Now</button>
          </div>
        </div>
        <div>
          <label>LZç€</label>
          <div class="time-row">
            <input type="time" id="ems_lz">
            <button class="time-btn" onclick="setNow('ems_lz')">Now</button>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addEmsVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="ems_vitals_container"></div>

      <h3>æ¥è§¦æ™‚æ‰€è¦‹</h3>
      <div class="exam-tabs" id="ems_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="ems-gen-head"></div>
        <textarea class="memo" id="memo-ems-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="ems-gen-resp"></div>
        <textarea class="memo" id="memo-ems-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="ems-gen-card"></div>
        <textarea class="memo" id="memo-ems-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="ems-gen-abd"></div>
        <textarea class="memo" id="memo-ems-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="ems-gen-limb"></div>
        <textarea class="memo" id="memo-ems-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="ems-gen-neuro"></div>
        <textarea class="memo" id="memo-ems-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="ems-tra-head"></div>
        <textarea class="memo" id="memo-ems-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="ems-tra-neck"></div>
        <textarea class="memo" id="memo-ems-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="ems-tra-chest"></div>
        <textarea class="memo" id="memo-ems-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="ems-tra-abd"></div>
        <textarea class="memo" id="memo-ems-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3>
        <div class="chips" id="ems-tra-pelvis"></div>
        <textarea class="memo" id="memo-ems-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="ems-tra-limb"></div>
        <textarea class="memo" id="memo-ems-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>æ„è­˜</h3>
        <div class="chips" id="ems-str-conscious"></div>
        <h3>é¡”é¢ãƒ»ç™ºèª</h3>
        <div class="chips" id="ems-str-face"></div>
        <h3>é‹å‹•</h3>
        <div class="chips" id="ems-str-motor"></div>
        <h3>ãã®ä»–ç—‡çŠ¶</h3>
        <div class="chips" id="ems-str-other"></div>
        <label style="margin-top:12px">ç™ºç—‡æ™‚åˆ»</label>
        <div class="time-row">
          <input type="time" id="ems_stroke_onset">
          <button class="time-btn" onclick="setNow('ems_stroke_onset')">Now</button>
        </div>
        <textarea class="memo" id="memo-ems-str" placeholder="è„³å’ä¸­æ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>åˆæœŸæ³¢å½¢</h3>
        <div class="chips" id="ems-cpa-rhythm"></div>
        <h3>ç›®æ’ƒãƒ»ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼</h3>
        <div class="chips" id="ems-cpa-witness"></div>
        <h3>æ°—é“</h3>
        <div class="chips" id="ems-cpa-airway"></div>
        <h3>å¾ªç’°</h3>
        <div class="chips" id="ems-cpa-circulation"></div>
        <h3>èƒ¸è…¹éƒ¨</h3>
        <div class="chips" id="ems-cpa-chest"></div>
        <textarea class="memo" id="memo-ems-cpa" placeholder="CPAæ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
      </div>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="ems_procedures"></div>
      <div id="ems_o2_amount" style="display:none;margin-top:8px">
        <label>é…¸ç´ æŠ•ä¸é‡</label>
        <select id="ems_o2_flow">
          <option value="">é¸æŠ</option>
          <option value="1L/min">1L/min</option>
          <option value="2L/min">2L/min</option>
          <option value="3L/min">3L/min</option>
          <option value="5L/min">5L/min</option>
          <option value="6L/min">6L/min</option>
          <option value="10L/min">10L/min</option>
          <option value="ãƒªã‚¶ãƒ¼ãƒãƒ¼10L">ãƒªã‚¶ãƒ¼ãƒãƒ¼10L</option>
          <option value="ãƒªã‚¶ãƒ¼ãƒãƒ¼15L">ãƒªã‚¶ãƒ¼ãƒãƒ¼15L</option>
        </select>
      </div>
      <label>å‡¦ç½®è©³ç´°</label>
      <textarea id="ems_procedures_detail" placeholder="ãã®ä»–ã®å‡¦ç½®"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ğŸ‘¨â€âš•ï¸ ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼</div>
    <div class="card-body">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addFdVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="fd_vitals_container"></div>

      <h3 style="margin-top:16px">èº«ä½“æ‰€è¦‹</h3>
      <div class="exam-tabs" id="fd_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="fd-gen-head"></div>
        <textarea class="memo" id="memo-fd-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="fd-gen-resp"></div>
        <textarea class="memo" id="memo-fd-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="fd-gen-card"></div>
        <textarea class="memo" id="memo-fd-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="fd-gen-abd"></div>
        <textarea class="memo" id="memo-fd-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="fd-gen-limb"></div>
        <textarea class="memo" id="memo-fd-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="fd-gen-neuro"></div>
        <textarea class="memo" id="memo-fd-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="fd-tra-head"></div>
        <textarea class="memo" id="memo-fd-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="fd-tra-neck"></div>
        <textarea class="memo" id="memo-fd-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="fd-tra-chest"></div>
        <textarea class="memo" id="memo-fd-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="fd-tra-abd"></div>
        <textarea class="memo" id="memo-fd-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3>
        <div class="chips" id="fd-tra-pelvis"></div>
        <textarea class="memo" id="memo-fd-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="fd-tra-limb"></div>
        <textarea class="memo" id="memo-fd-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>è„³ç¥çµŒæ‰€è¦‹</h3>
        <div class="chips" id="fd-str-cn"></div>
        <textarea class="memo" id="memo-fd-str-cn" placeholder="è„³ç¥çµŒãƒ¡ãƒ¢"></textarea>

        <h3>ç³å­”ãƒ»çœ¼çƒé‹å‹•</h3>
        <div class="grid2">
          <div>
            <label>ç³å­”å¾„ å·¦(mm)</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openPupilDial('L')">
              <span class="vital-value" id="pupilL_display">3</span>
            </div>
          </div>
          <div>
            <label>ç³å­”å¾„ å³(mm)</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openPupilDial('R')">
              <span class="vital-value" id="pupilR_display">3</span>
            </div>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>å¯¾å…‰åå°„ å·¦</label>
            <select id="plrL">
              <option value="">--</option>
              <option value="è¿…é€Ÿ">è¿…é€Ÿ</option>
              <option value="é…å»¶">é…å»¶</option>
              <option value="æ¶ˆå¤±">æ¶ˆå¤±</option>
            </select>
          </div>
          <div>
            <label>å¯¾å…‰åå°„ å³</label>
            <select id="plrR">
              <option value="">--</option>
              <option value="è¿…é€Ÿ">è¿…é€Ÿ</option>
              <option value="é…å»¶">é…å»¶</option>
              <option value="æ¶ˆå¤±">æ¶ˆå¤±</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>å…±åŒåè¦–</label>
            <select id="str_gaze">
              <option value="">--</option>
              <option value="ãªã—">ãªã—</option>
              <option value="å³æ–¹">å³æ–¹</option>
              <option value="å·¦æ–¹">å·¦æ–¹</option>
            </select>
          </div>
          <div>
            <label>çœ¼æŒ¯</label>
            <select id="str_nyst">
              <option value="">--</option>
              <option value="ãªã—">ãªã—</option>
              <option value="æ°´å¹³">æ°´å¹³</option>
              <option value="å‚ç›´">å‚ç›´</option>
              <option value="å›æ—‹">å›æ—‹</option>
            </select>
          </div>
        </div>
        <textarea class="memo" id="memo-fd-str-eye" placeholder="çœ¼æ‰€è¦‹ãƒ¡ãƒ¢"></textarea>

        <h3>é‹å‹•ï¼ˆMMT 0-5ï¼‰</h3>
        <div class="grid2">
          <div>
            <label>å³ä¸Šè‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openMmtDial('ru')">
              <span class="vital-value" id="mmt_ru_display">5</span>
            </div>
          </div>
          <div>
            <label>å·¦ä¸Šè‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openMmtDial('lu')">
              <span class="vital-value" id="mmt_lu_display">5</span>
            </div>
          </div>
          <div>
            <label>å³ä¸‹è‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openMmtDial('rl')">
              <span class="vital-value" id="mmt_rl_display">5</span>
            </div>
          </div>
          <div>
            <label>å·¦ä¸‹è‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openMmtDial('ll')">
              <span class="vital-value" id="mmt_ll_display">5</span>
            </div>
          </div>
        </div>
        <textarea class="memo" id="memo-fd-str-motor" placeholder="é‹å‹•æ‰€è¦‹ãƒ¡ãƒ¢"></textarea>

        <h3>åå°„ãƒ»éŒä½“è·¯</h3>
        <div class="grid2">
          <div><label>BTR</label><select id="str_btr"><option value="">--</option><option value="æ­£å¸¸">æ­£å¸¸</option><option value="äº¢é€²">äº¢é€²</option><option value="ä½ä¸‹">ä½ä¸‹</option></select></div>
          <div><label>PTR</label><select id="str_ptr"><option value="">--</option><option value="æ­£å¸¸">æ­£å¸¸</option><option value="äº¢é€²">äº¢é€²</option><option value="ä½ä¸‹">ä½ä¸‹</option></select></div>
        </div>
        <div class="checkline" style="margin-top:8px">
          <label><input type="checkbox" id="str_babinski"> Babinskié™½æ€§</label>
          <label><input type="checkbox" id="str_chaddock"> Chaddocké™½æ€§</label>
        </div>
        <textarea class="memo" id="memo-fd-str-reflex" placeholder="åå°„ãƒ¡ãƒ¢"></textarea>

        <h3>é«˜æ¬¡è„³æ©Ÿèƒ½ãƒ»å°è„³</h3>
        <div class="chips" id="fd-str-higher"></div>
        <textarea class="memo" id="memo-fd-str-higher" placeholder="é«˜æ¬¡è„³ãƒ»å°è„³ãƒ¡ãƒ¢"></textarea>

        <details style="margin-top:12px;background:#f8fafc;border-radius:10px;padding:12px;border:1px solid var(--line)">
          <summary style="font-weight:600;cursor:pointer">NIHSS <span id="nihss_sum" style="margin-left:8px;background:var(--brand);color:#fff;padding:2px 10px;border-radius:12px;font-size:13px">0ç‚¹</span></summary>
          <div style="margin-top:12px" id="nihss_area"></div>
          <label style="margin-top:8px">NIHSSãƒ¡ãƒ¢</label>
          <textarea class="memo" id="nihss_memo" placeholder="NIHSSè©•ä¾¡ãƒ¡ãƒ¢"></textarea>
        </details>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
        <div id="cpa_events_container"></div>
        <button class="btn small" style="margin-top:12px" onclick="addCpaEvent()">ï¼‹ å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>
      </div>

      <h3>æ¤œæŸ»</h3>
      <div class="checkline">
        <label><input type="checkbox" id="exam_bs" onchange="toggleExam('bs')"> è¡€ç³–</label>
        <label><input type="checkbox" id="exam_us" onchange="toggleExam('us')"> US</label>
        <label><input type="checkbox" id="exam_ecg" onchange="toggleExam('ecg')"> 12èª˜å°å¿ƒé›»å›³</label>
        <label><input type="checkbox" id="exam_fast" onchange="toggleExam('fast')"> FAST</label>
        <label><input type="checkbox" id="exam_efast" onchange="toggleExam('efast')"> eFAST</label>
      </div>
      <div id="exam_bs_area" style="display:none;margin-top:8px">
        <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:12px;cursor:pointer;display:inline-block" onclick="openBsDial()">
          <div class="vital-value" id="fd_bs_display">120</div><div class="vital-unit">mg/dL</div>
        </div>
        <input type="hidden" id="fd_bs" value="120">
      </div>
      <textarea id="exam_us_txt" placeholder="USæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_ecg_txt" placeholder="12èª˜å°æ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_fast_txt" placeholder="FASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_efast_txt" placeholder="eFASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      
      <div class="grid2" style="margin-top:8px">
        <div><label>è¡€ã‚¬ã‚¹</label><select id="fd_abg_type" onchange="toggleAbg()"><option value="">æœªå®Ÿæ–½</option><option value="ABG">ABG</option><option value="VBG">VBG</option></select></div>
      </div>
      <div id="abg_area" style="display:none;margin-top:10px">
        <div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn small" onclick="addAbgSet()">ã‚»ãƒƒãƒˆè¿½åŠ </button><button class="btn small ghost" onclick="clearAbg()">ã‚¯ãƒªã‚¢</button></div>
        <div id="abg_pills" class="labline"></div>
      </div>
      
      <label>æ¤œæŸ»è©³ç´°</label>
      <textarea id="fd_exam_detail" placeholder="æ¤œæŸ»ã®è£œè¶³"></textarea>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="fd_procedures"></div>
      <label>å‡¦ç½®è©³ç´°</label>
      <textarea id="fd_procedure_detail" placeholder="å‡¦ç½®è©³ç´°"></textarea>

      <h3>è–¬å‰¤æŠ•ä¸</h3>
      <div class="chips" id="fd_drugs"></div>
      <label>è–¬å‰¤è©³ç´°</label>
      <textarea id="fd_drug_detail" placeholder="è–¬å‰¤è©³ç´°"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ğŸ“‹ è©•ä¾¡ãƒ»æ¬é€</div>
    <div class="card-body">
      <h3>ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ </h3>
      <div style="display:flex;gap:8px;margin-bottom:10px"><input type="text" id="new_problem" placeholder="å…¥åŠ›" style="flex:1"><button class="btn small" onclick="addProblem()">è¿½åŠ </button></div>
      <div id="problems"></div>
      <label>è€ƒå¯Ÿ</label>
      <textarea id="consideration" placeholder="è‡¨åºŠæ¨è«–ãƒ»è€ƒå¯Ÿ"></textarea>
      <label>åŒ»ç™‚æ©Ÿé–¢</label>
      <div class="chips" id="destination_chips"></div>
      <input type="text" id="destination_custom" placeholder="è‡ªç”±å…¥åŠ›">
      <div id="destination_display" style="margin-top:8px;padding:10px;background:#e0f2fe;border-radius:8px;display:none"><span style="font-size:13px;color:#0369a1">é¸æŠä¸­ï¼š</span><strong id="destination_selected"></strong></div>
      <label>é¸å®šç†ç”±</label>
      <textarea id="selection_reason" placeholder="é¸å®šç†ç”±"></textarea>
      <label>æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
      <select id="turn_type"><option value="Iã‚¿ãƒ¼ãƒ³">Iã‚¿ãƒ¼ãƒ³</option><option value="Jã‚¿ãƒ¼ãƒ³">Jã‚¿ãƒ¼ãƒ³</option><option value="Uã‚¿ãƒ¼ãƒ³">Uã‚¿ãƒ¼ãƒ³</option></select>
      <div id="transport_times" style="display:none">
        <div class="grid2">
          <div><label>æ¬é€é›¢é™¸</label><div class="time-row"><input type="time" id="transport_takeoff"><button class="time-btn" onclick="setNow('transport_takeoff')">Now</button></div></div>
          <div><label>ç—…é™¢ç€</label><div class="time-row"><input type="time" id="hospital_arrival"><button class="time-btn" onclick="setNow('hospital_arrival')">Now</button></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card"><div class="card-header">ğŸ“„ æ´»å‹•è¨˜éŒ²</div><div class="card-body"><div class="result" id="outText"></div></div></div>
</main>

<div class="bottom-nav">
  <button class="btn" id="copyOut">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
  <button class="btn ghost" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
  <button class="btn ghost" onclick="loadData()">ğŸ“‚ èª­è¾¼</button>
  <button class="btn ghost" onclick="resetData()" style="color:#dc2626">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div class="dial-overlay" id="dialOverlay" onclick="closeDial(event)"><div class="dial-container" onclick="event.stopPropagation()" ontouchmove="event.stopPropagation()"><div class="dial-header"><span class="dial-title" id="dialTitle">é¸æŠ</span><button class="dial-done" onclick="confirmDial()">å®Œäº†</button></div><div class="dial-body" id="dialBody"></div></div></div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// ãƒã‚¹ã‚¿å®šç¾©
const EMS_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”è‰²è‰¯å¥½'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','å†·æ±—','ç™ºç†±']},
  resp: {normal:['å‘¼å¸å®‰å®š','å‘¼å¸è‹¦ãªã—'], abn:['å‘¼å¸å›°é›£','åŠªåŠ›å‘¼å¸','é »å‘¼å¸','èµ·åå‘¼å¸','é™¥æ²¡å‘¼å¸']},
  card: {normal:['è„ˆæ‹æ•´','æœ«æ¢¢æ¸©ã‹ã„'], abn:['è„ˆæ‹ä¸æ•´','é »è„ˆ','å¾è„ˆ','æœ«æ¢¢å†·æ„Ÿ','å†·æ±—']},
  abd: {normal:['è…¹éƒ¨å¹³å¦','åœ§ç—›ãªã—'], abn:['è…¹éƒ¨è†¨æº€','åœ§ç—›','ç­‹æ€§é˜²å¾¡','å˜”å']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','ä¸‹è…¿æµ®è…«','å¤‰å½¢']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”å·¦å³å·®']}
};
const EMS_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²','å‰é¡éƒ¨è¡€è…«','å‰é¡éƒ¨æŒ«å‰µ','å´é ­éƒ¨æ‰“æ’²','å´é ­éƒ¨è¡€è…«','å¾Œé ­éƒ¨æ‰“æ’²','å¾Œé ­éƒ¨æŒ«å‰µ','é¡”é¢æ‰“æ’²','é¡”é¢æŒ«å‰µ','é¡”é¢å¤‰å½¢','çœ¼å‘¨å›²è…«è„¹','é¼»å‡ºè¡€','è€³å‡ºè¡€','å£è…”å†…å‡ºè¡€','æ­¯ç‰™æå‚·']},
  neck: {normal:['å¾Œé ¸éƒ¨åœ§ç—›ãªã—','æ°—ç®¡åä½ãªã—'], abn:['é ¸éƒ¨æ‰“æ’²','é ¸éƒ¨æŒ«å‰µ','å¾Œé ¸éƒ¨åœ§ç—›','é ¸éƒ¨çš®ä¸‹æ°—è…«','é ¸é™è„ˆæ€’å¼µ','æ°—ç®¡åä½']},
  chest: {normal:['å‘¼å¸éŸ³å·¦å³å·®ãªã—'], abn:['èƒ¸å£æ‰“æ’²','èƒ¸å£æŒ«å‰µ','èƒ¸å£åœ§ç—›','èƒ¸éƒ­å¤‰å½¢','å‹•æºèƒ¸éƒ­','èƒ¸å£çš®ä¸‹æ°—è…«','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±']},
  abd: {normal:[], abn:['è…¹å£æ‰“æ’²','è…¹å£æŒ«å‰µ','è…¹éƒ¨åœ§ç—›','è…¹éƒ¨è†¨æº€','ç­‹æ€§é˜²å¾¡','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³','ãƒãƒ³ãƒ‰ãƒ«ç—•']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—'], abn:['éª¨ç›¤åœ§ç—›','éª¨ç›¤å‹•æº','ä¼šé™°éƒ¨å‡ºè¡€','ä¸‹è…¹éƒ¨è†¨æº€']},
  limb: {normal:['æœ«æ¢¢å‹•è„ˆè§¦çŸ¥è‰¯å¥½'], abn:['ä¸Šè‚¢æ‰“æ’²','ä¸Šè‚¢æŒ«å‰µ','ä¸Šè‚¢å¤‰å½¢','ä¸Šè‚¢è…«è„¹','ä¸‹è‚¢æ‰“æ’²','ä¸‹è‚¢æŒ«å‰µ','ä¸‹è‚¢å¤‰å½¢','ä¸‹è‚¢è…«è„¹','é–‹æ”¾å‰µ','æœ«æ¢¢å†·æ„Ÿ','æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯']}
};
const EMS_CPA_GROUPS = {
  rhythm: {normal:[], abn:['Vf','Pulseless VT','PEA','Asystole']},
  witness: {normal:['ç›®æ’ƒã‚ã‚Š','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š'], abn:['ç›®æ’ƒãªã—','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—']},
  airway: {normal:['å£è…”å†…ç•°ç‰©ãªã—','æ°—é“é–‹é€šè‰¯å¥½'], abn:['å£è…”å†…ç•°ç‰©','æ°—é“é–‰å¡','åç‰©','å‡ºè¡€']},
  circulation: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','æ©ˆéª¨å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  chest: {normal:['èƒ¸éƒ­æŒ™ä¸Šè‰¯å¥½','å‘¼å¸éŸ³å·¦å³å·®ãªã—','è…¹éƒ¨è†¨éš†ãªã—'], abn:['èƒ¸éƒ­æŒ™ä¸Šä¸è‰¯','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±','çš®ä¸‹æ°—è…«','è…¹éƒ¨è†¨éš†','ä¸‹è…¿æµ®è…«']}
};
const EMS_STR_GROUPS = {
  conscious: {normal:['æ„è­˜æ¸…æ˜'], abn:['æ„è­˜éšœå®³','JCS 1æ¡','JCS 2æ¡','JCS 3æ¡']},
  face: {normal:['é¡”é¢éº»ç—ºãªã—','æ§‹éŸ³éšœå®³ãªã—'], abn:['é¡”é¢éº»ç—º','æ§‹éŸ³éšœå®³','å‘‚å¾‹éšœå®³']},
  motor: {normal:['ä¸Šè‚¢ä¿æŒå¯','ä¸‹è‚¢ä¿æŒå¯'], abn:['ä¸Šè‚¢è½ä¸‹(å³)','ä¸Šè‚¢è½ä¸‹(å·¦)','ä¸‹è‚¢è½ä¸‹(å³)','ä¸‹è‚¢è½ä¸‹(å·¦)','ç‰‡éº»ç—º(å³)','ç‰‡éº»ç—º(å·¦)']},
  other: {normal:[], abn:['ç³å­”ä¸åŒ','å…±åŒåè¦–','é ­ç—›','å˜”å','ã‚ã¾ã„','ç—™æ”£','å¤±èª']}
};
const FD_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”é¢è’¼ç™½ãªã—','ãƒã‚¢ãƒãƒ¼ã‚¼ãªã—'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','ç™ºç†±']},
  resp: {normal:['å‘¼å¸éŸ³æ¸…','å–˜é³´ãªã—'], abn:['å‘¼å¸å›°é›£','å–˜é³´','æ¹¿æ€§ãƒ©éŸ³','coarse crackles','fine crackles']},
  card: {normal:['å¿ƒéŸ³ç´”','ä¸æ•´ãªã—','ä¸‹è…¿æµ®è…«ãªã—'], abn:['ã‚·ãƒ§ãƒƒã‚¯å…†å€™','å¿ƒé›‘éŸ³','ä¸æ•´è„ˆ','å†·æ±—','ä¸‹è…¿æµ®è…«']},
  abd: {normal:['è…¹éƒ¨å¹³å¦è»Ÿ','åœ§ç—›ãªã—','åè·³ç—›ãªã—'], abn:['è…¹ç—›','åœ§ç—›','åè·³ç—›','ç­‹æ€§é˜²å¾¡','æ¿çŠ¶ç¡¬']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','æµ®è…«','å¤‰å½¢','æœ«æ¢¢å¾ªç’°ä¸å…¨']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”ä¸åŒ','å¯¾å…‰åå°„ç•°å¸¸']}
};
const FD_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²è¡€è…«','å´é ­éƒ¨æ‰“æ’²è¡€è…«','å¾Œé ­éƒ¨æŒ«å‰µ','é ­çš®è£‚å‚·','é¡”é¢æŒ«å‰µ','é¡”é¢è…«è„¹','ãƒ‘ãƒ³ãƒ€ã®ç›®å¾´å€™','ãƒãƒˆãƒ«ã‚µã‚¤ãƒ³','é¼»æ ¹éƒ¨è…«è„¹','å³é ¬éƒ¨å¤‰å½¢è…«è„¹','å·¦é ¬éƒ¨å¤‰å½¢è…«è„¹','é¼»å‡ºè¡€','è€³å‡ºè¡€','é«„æ¶²è€³æ¼','é«„æ¶²é¼»æ¼','å£è…”å†…å‡ºè¡€','æ­¯ç‰™æå‚·','çµè†œå‡ºè¡€','è§’è†œæå‚·','çœ¼çƒåä½','è¤‡è¦–']},
  neck: {normal:['æ°—ç®¡æ­£ä¸­','é ¸éƒ¨çš®ä¸‹æ°—è…«ãªã—','é ¸é™è„ˆæ€’å¼µãªã—','å¾Œé ¸éƒ¨åœ§ç—›ãªã—'], abn:['æ°—ç®¡åä½','é ¸éƒ¨çš®ä¸‹æ°—è…«','é ¸é™è„ˆæ€’å¼µ','å¾Œé ¸éƒ¨åœ§ç—›','é ¸éƒ¨æ‰“æ’²','é ¸éƒ¨æŒ«å‰µ','é ¸éƒ¨è¡€è…«']},
  chest: {normal:['èƒ¸éƒ­å¯¾ç§°','å‘¼å¸éŸ³æ¸…å·¦å³å·®ãªã—','å¿ƒéŸ³æ•´'], abn:['èƒ¸éƒ­å¤‰å½¢','å‹•æºèƒ¸éƒ­','èƒ¸å£æ‰“æ’²','èƒ¸å£æŒ«å‰µ','èƒ¸å£åœ§ç—›','èƒ¸å£çš®ä¸‹æ°—è…«','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±','å³å‘¼å¸éŸ³æ¶ˆå¤±','å·¦å‘¼å¸éŸ³æ¶ˆå¤±','å¿ƒéŸ³æ¸›å¼±']},
  abd: {normal:['è…¹éƒ¨å¹³å¦è»Ÿ'], abn:['è…¹å£æ‰“æ’²','è…¹å£æŒ«å‰µ','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³','ãƒãƒ³ãƒ‰ãƒ«ç—•','è…¹éƒ¨åœ§ç—›','å³ä¸Šè…¹éƒ¨åœ§ç—›','å·¦ä¸Šè…¹éƒ¨åœ§ç—›','ä¸‹è…¹éƒ¨åœ§ç—›','ç­‹æ€§é˜²å¾¡','åè·³ç—›','è…¹éƒ¨è†¨æº€','è…¸è •å‹•éŸ³æ¸›å¼±']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—','ç›´è…¸è¨ºç•°å¸¸ãªã—'], abn:['éª¨ç›¤å‹•æº','éª¨ç›¤åœ§ç—›','æ¥éª¨åœ§ç—›','ä¼šé™°éƒ¨å‡ºè¡€','å°¿é“å‡ºè¡€']},
  limb: {normal:['æœ«æ¢¢å‹•å‹•è„ˆè§¦çŸ¥è‰¯å¥½'], abn:['å³ä¸Šè‚¢æ‰“æ’²','å³ä¸Šè‚¢æŒ«å‰µ','å³ä¸Šè‚¢å¤‰å½¢','å³ä¸Šè‚¢è…«è„¹','å·¦ä¸Šè‚¢æ‰“æ’²','å·¦ä¸Šè‚¢æŒ«å‰µ','å·¦ä¸Šè‚¢å¤‰å½¢','å·¦ä¸Šè‚¢è…«è„¹','å³ä¸‹è‚¢æ‰“æ’²','å³ä¸‹è‚¢æŒ«å‰µ','å³ä¸‹è‚¢å¤‰å½¢','å³ä¸‹è‚¢è…«è„¹','å·¦ä¸‹è‚¢æ‰“æ’²','å·¦ä¸‹è‚¢æŒ«å‰µ','å·¦ä¸‹è‚¢å¤‰å½¢','å·¦ä¸‹è‚¢è…«è„¹','é–‹æ”¾å‰µ','éª¨éœ²å‡º','æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯','æœ«æ¢¢å†·æ„Ÿ','CRTå»¶é•·']}
};
const FD_STR_GROUPS = {
  cn: {normal:[], abn:['è¦–åŠ›ä½ä¸‹','è¦–é‡æ¬ æ','è¤‡è¦–','çœ¼ç¼ä¸‹å‚','é¡”é¢éº»ç—º','é¡”é¢æ„Ÿè¦šä½ä¸‹','è´åŠ›ä½ä¸‹','ã‚ã¾ã„','æ§‹éŸ³éšœå®³','åš¥ä¸‹éšœå®³','èˆŒåä½','ã‚«ãƒ¼ãƒ†ãƒ³å¾´å€™']},
  higher: {normal:[], abn:['å¤±èª','é‹å‹•æ€§å¤±èª','æ„Ÿè¦šæ€§å¤±èª','æ§‹éŸ³éšœå®³','å¤±è¡Œ','å¤±èª','åŠå´ç©ºé–“ç„¡è¦–','æ³¨æ„éšœå®³','è¦‹å½“è­˜éšœå®³','å°è„³å¤±èª¿','æŒ‡é¼»è©¦é¨“ç•°å¸¸','è¸µè†è©¦é¨“ç•°å¸¸']}
};
const FD_CPA_GROUPS = {
  body: {normal:[], abn:['å¿ƒåœæ­¢','å‘¼å¸åœæ­¢','ãƒã‚¢ãƒãƒ¼ã‚¼','å››è‚¢å†·æ„Ÿ','çš®è†šè’¼ç™½','æ­»æ–‘','æ­»å¾Œç¡¬ç›´']},
  head: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  trunk: {normal:[], abn:['å¿ƒéŸ³è´å–ä¸å¯','å‘¼å¸éŸ³è´å–ä¸å¯','è…¹éƒ¨è†¨éš†']}
};

// çŠ¶æ…‹
let state = {
  request: {type:'', detail:'', time:''},
  patient: {history:'', medication:'', allergy:'', lastMeal:'', hospital:''},
  heli: {takeoff:'', lz_landing:'', fd_contact:'', turn_type:'Iã‚¿ãƒ¼ãƒ³', transport_takeoff:'', hospital_arrival:''},
  ems: { aware:'', arrival:'', contact:'', lz:'', vitals: [], exam_tab: 'general', chips: {}, memos: {general:{},trauma:{},stroke:{},cpa:{}}, procedures: {}, procedures_items: ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'], o2_flow:'', procedures_detail:'', stroke_onset:'' },
  fd: { vitals: [], exam_tab: 'general', chips: {}, memos: {general:{},trauma:{},stroke:{},cpa:{}}, exams: {bs:false, us:false, ecg:false, fast:false, efast:false}, exam_texts: {us:'', ecg:'', fast:'', efast:''}, bs:120, abg_type:'', abg_data: [], exam_detail:'', cpaEvents: [], stroke: { pupilL:3, pupilR:3, plrL:'', plrR:'', gaze:'', nyst:'', mmt:{ru:5, lu:5, rl:5, ll:5}, btr:'', ptr:'', babinski:false, chaddock:false, nihss:{}, nihssMemo:'' }, procedures: {}, procedures_items: ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'], procedure_detail:'', drugs: {}, drugs_items: ['ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹'], drug_detail:'' },
  problems: [], consideration: '', destination: {hospital:'', custom:'', reason:''},
  hospitals: {'é¹¿å…å³¶': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','å—é¢¨ç—…é™¢','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢'], 'å—è–©': ['æŒ‡å®¿åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ä»Šæ—æ•´å½¢å¤–ç§‘ç—…é™¢','å±±å·ç—…é™¢','å°åŸç—…é™¢','åŠ ä¸–ç”°ç—…é™¢','èŠé‡ç—…é™¢','ä¹…æœ¨ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','çœŒç«‹è–©å—ç—…é™¢','ã‚µã‚¶ãƒ³ãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç—…é™¢','åŠæ´¥ç—…é™¢','æ•å´å¸‚ç«‹ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ‰é¦¬ç—…é™¢'], 'å·è–©': ['æ¸ˆç”Ÿä¼šå·å†…ç—…é™¢','å·å†…å¸‚åŒ»å¸«ä¼šç«‹å¸‚æ°‘ç—…é™¢','å“ç¿”ä¼šè¨˜å¿µç—…é™¢','ä¸Šæ‘ç—…é™¢','é«˜æ±Ÿè¨˜å¿µç—…é™¢','æ£®åœ’è¨˜å¿µç—…é™¢','è‹¥æ¾è¨˜å¿µç—…é™¢','è–©æ‘©éƒ¡åŒ»å¸«ä¼šç—…é™¢'], 'å‡ºæ°´': ['å‡ºæ°´éƒ¡åŒ»å¸«ä¼šåºƒåŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å‡ºæ°´ç·åˆåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å†…å±±ç—…é™¢'], 'éœ§å³¶': ['éœ§å³¶å¸‚ç«‹åŒ»å¸«ä¼šåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å›½åˆ†ç”Ÿå”ç—…é™¢','éœ§å³¶è¨˜å¿µç—…é™¢','å¤§äº•ç—…é™¢','åŠ æ²»æœ¨æ•´å½¢å¤–ç§‘ç—…é™¢','åŠ æ²»æœ¨æ¸©æ³‰ç—…é™¢','éœ§å³¶æ‰å®‰ç—…é™¢','éœ§å³¶æ•´å½¢å¤–ç§‘ç—…é™¢','å›½åˆ†ä¸­å¤®ç—…é™¢','å›½åˆ†è„³ç¥çµŒå¤–ç§‘ç—…é™¢','é’é›²ä¼šç—…é™¢','çœŒç«‹åŒ—è–©ç—…é™¢','æ•´å½¢å¤–ç§‘æ¾å…ƒç—…é™¢','å¯ºç”°ç—…é™¢'], 'æ›½æ–¼': ['æ˜­å—ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯åˆ†é™¢','ã³ã‚ã†ã®æ¨¹è„³ç¥çµŒå¤–ç§‘'], 'è‚å±': ['çœŒæ°‘å¥åº·ãƒ—ãƒ©ã‚¶é¹¿å±‹åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å¤§éš…é¹¿å±‹ç—…é™¢','æ± ç”°ç—…é™¢','ã‹ã®ã‚„æ±ç—…é™¢','è‚å±éƒ¡åŒ»å¸«ä¼šç«‹ç—…é™¢','è‚ä»˜ç”ºç«‹ç—…é™¢','æ’å¿ƒä¼šãŠãã‚‰ç—…é™¢','å‚æ°´ä¸­å¤®ç—…é™¢','é»æ˜è„³ç¥çµŒå¤–ç§‘åŒ»é™¢','å¾³ç”°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','ã³ã‚ã†ã®æ¨¹'], 'ç†Šæ¯›': ['ç¨®å­å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å±‹ä¹…å³¶å¾³æ´²ä¼šç—…é™¢'], 'å¥„ç¾': ['çœŒç«‹å¤§å³¶ç—…é™¢','å¥„ç¾ä¸­å¤®ç—…é™¢','åç€¬å¾³æ´²ä¼šç—…é™¢','ç€¬æˆ¸å†…å¾³æ´²ä¼šç—…é™¢','å¾³ä¹‹å³¶å¾³æ´²ä¼šç—…é™¢','æ²–æ°¸è‰¯éƒ¨å¾³æ´²ä¼šç—…é™¢','å–œç•Œå¾³æ´²ä¼šç—…é™¢','å—æºŸä¼šå®®ä¸Šç—…é™¢','ä¸è«–å¾³æ´²ä¼šç—…é™¢']}
};

// ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼
let dialCallback = null; let dialWheels = []; let scrollPosition = 0;
function openDial(title, wheels, callback) {
  scrollPosition = window.pageYOffset; document.body.classList.add('dial-open'); document.body.style.top = `-${scrollPosition}px`;
  dialCallback = callback; dialWheels = wheels; $('#dialTitle').textContent = title;
  const body = $('#dialBody'); body.innerHTML = '';
  wheels.forEach((w, wi) => {
    const wheel = document.createElement('div'); wheel.className = 'dial-wheel'; wheel.innerHTML = '<div class="dial-highlight"></div>';
    const scroll = document.createElement('div'); scroll.className = 'dial-scroll'; scroll.dataset.wheelIndex = wi;
    w.options.forEach((opt, oi) => { const div = document.createElement('div'); div.className = 'dial-option'; div.textContent = opt.label; div.dataset.value = opt.value; if(opt.value == w.selected) div.classList.add('selected'); scroll.appendChild(div); });
    wheel.appendChild(scroll); body.appendChild(wheel);
    if(w.unit) { const unit = document.createElement('div'); unit.className = 'dial-unit'; unit.textContent = w.unit; body.appendChild(unit); }
    let curIdx = w.options.findIndex(o => o.value == w.selected); if(curIdx < 0) curIdx = 0;
    let offset = -curIdx * 40; let startY = 0; scroll.style.transform = `translateY(${offset}px)`;
    scroll.addEventListener('touchstart', e => { e.preventDefault(); startY = e.touches[0].clientY; }, {passive: false});
    scroll.addEventListener('touchmove', e => { e.preventDefault(); const dy = e.touches[0].clientY - startY; offset += dy; scroll.style.transform = `translateY(${offset}px)`; startY = e.touches[0].clientY; }, {passive: false});
    scroll.addEventListener('touchend', e => { e.preventDefault(); let i = Math.round(-offset/40); i = Math.max(0, Math.min(w.options.length-1, i)); offset = -i*40; w.selected = w.options[i].value; scroll.style.transition = 'transform 0.2s'; scroll.style.transform = `translateY(${offset}px)`; scroll.querySelectorAll('.dial-option').forEach((o, k) => o.classList.toggle('selected', k === i)); if(dialWheels.length === 1) setTimeout(confirmDial, 200); }, {passive: false});
  });
  $('#dialOverlay').classList.add('show');
}
function closeDial() { $('#dialOverlay').classList.remove('show'); document.body.classList.remove('dial-open'); document.body.style.top = ''; window.scrollTo(0, scrollPosition); }
function confirmDial() { if(dialCallback) dialCallback(dialWheels.map(w => w.selected)); closeDial(); }

function genRange(f, t, s) { let a = []; for(let i=f; i<=t; i+=s) a.push({label: String(i), value: i}); return a; }
function genRangeBT() { let a = []; for(let i=32.0; i<=42.0; i+=0.1) a.push({label: i.toFixed(1), value: parseFloat(i.toFixed(1))}); return a; }

function openVitalDial(type, idx, field) {
  const v = state[type].vitals[idx]; let wheels = [], title = '';
  switch(field) {
    case 'bp': title = 'è¡€åœ§'; wheels = [{options: genRange(0, 250, 1), selected: v.sbp, unit: '/'},{options: genRange(0, 150, 1), selected: v.dbp, unit: 'mmHg'}]; break;
    case 'hr': title = 'å¿ƒæ‹æ•°'; wheels = [{options: genRange(0, 250, 1), selected: v.hr, unit: 'bpm'}]; break;
    case 'rr': title = 'å‘¼å¸æ•°'; wheels = [{options: genRange(0, 45, 1), selected: v.rr, unit: '/min'}]; break;
    case 'spo2': title = 'SpO2'; wheels = [{options: genRange(40, 100, 1), selected: v.spo2, unit: '%'}]; break;
    case 'bt': title = 'ä½“æ¸©'; wheels = [{options: genRangeBT(), selected: v.bt, unit: 'â„ƒ'}]; break;
    case 'gcs_e': title = 'GCS-E'; wheels = [{options: genRange(1,4,1), selected: v.gcs.e}]; break;
    case 'gcs_v': title = 'GCS-V'; wheels = [{options: [1,2,3,4,5,'T'].map(x=>({label:String(x),value:x})), selected: v.gcs.v}]; break;
    case 'gcs_m': title = 'GCS-M'; wheels = [{options: genRange(1,6,1), selected: v.gcs.m}]; break;
    case 'jcs': title = 'JCS'; wheels = [{options: ['0','1','2','3','10','20','30','100','200','300'].map(x=>({label:x,value:x})), selected: v.jcs}]; break;
  }
  openDial(title, wheels, vals => {
    if(field==='bp'){v.sbp=vals[0];v.dbp=vals[1]} else if(field==='hr')v.hr=vals[0]; else if(field==='rr')v.rr=vals[0]; else if(field==='spo2')v.spo2=vals[0]; else if(field==='bt')v.bt=vals[0]; else if(field.startsWith('gcs_'))v.gcs[field.split('_')[1]]=vals[0]; else if(field==='jcs')v.jcs=vals[0];
    type==='ems'?renderEmsVitals():renderFdVitals(); updateState();
  });
}

function openBsDial() { openDial('è¡€ç³–å€¤', [{options: genRange(0, 600, 1), selected: state.fd.bs||120, unit: 'mg/dL'}], vals => { state.fd.bs=vals[0]; $('#fd_bs_display').textContent=vals[0]; updateState(); }); }

function addCpaEvent() { const n = new Date(); const t = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; state.fd.cpaEvents.push({ arrestTime: t, rhythm: 'Asystole', witnessed: false, bystander: false, cprStart: '', ivTime: '', adrenalineTimes: [], lt: false, intubation: false, intubationTime: '', pericardio: false, pericardioTime: '', roscTime: '', memo: '' }); renderCpaEvents(); updateState(); }
function deleteCpaEvent(i) { if(confirm('å‰Šé™¤?')) { state.fd.cpaEvents.splice(i, 1); renderCpaEvents(); updateState(); } }
function renderCpaEvents() {
  const c = $('#cpa_events_container'); c.innerHTML = '';
  state.fd.cpaEvents.forEach((ev, idx) => {
    const card = document.createElement('div'); card.className = 'vital-card'; card.style.marginBottom = '12px';
    const noFlow = calcTimeDiff(ev.arrestTime, ev.cprStart); const lowFlow = calcTimeDiff(idx===0?ev.cprStart:ev.arrestTime, ev.roscTime);
    card.innerHTML = `<div class="vital-header"><span>ã‚¤ãƒ™ãƒ³ãƒˆ ${idx+1}</span><button class="vital-del" onclick="deleteCpaEvent(${idx})">å‰Šé™¤</button></div>
      <div style="padding:12px">
        <div class="grid2"><div><label>æ™‚åˆ»</label><input type="time" value="${ev.arrestTime}" onchange="updateCpaEventField(${idx},'arrestTime',this.value)"></div><div onclick="openCpaRhythmDial(${idx})"><label>æ³¢å½¢</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:10px">${ev.rhythm}</div></div></div>
        <div class="grid2" style="margin-top:12px"><div class="toggle-btn ${ev.witnessed?'active':''}" onclick="toggleCpaField(${idx},'witnessed')">ç›®æ’ƒã‚ã‚Š</div><div class="toggle-btn ${ev.bystander?'active':''}" onclick="toggleCpaField(${idx},'bystander')">BP-CPRã‚ã‚Š</div></div>
        <div style="margin-top:12px;padding:10px;background:#f0f9ff;border-radius:10px">No Flow: ${noFlow}åˆ† / Low Flow: ${lowFlow}åˆ†</div>
        <textarea class="memo" placeholder="ãƒ¡ãƒ¢" onchange="updateCpaEventField(${idx},'memo',this.value)">${ev.memo}</textarea>
      </div>`; c.appendChild(card);
  });
}
function calcTimeDiff(s, e) { if(!s || !e) return '--'; const [sh, sm] = s.split(':').map(Number); const [eh, em] = e.split(':').map(Number); let d = (eh*60+em) - (sh*60+sm); return d < 0 ? d+1440 : d; }
function updateCpaEventField(i, f, v) { state.fd.cpaEvents[i][f]=v; renderCpaEvents(); updateState(); }
function toggleCpaField(i, f) { state.fd.cpaEvents[i][f]=!state.fd.cpaEvents[i][f]; renderCpaEvents(); updateState(); }
function openCpaRhythmDial(i) { openDial('æ³¢å½¢', [{options:['Asystole','PEA','VF','pulseless VT'].map(x=>({label:x,value:x})), selected:state.fd.cpaEvents[i].rhythm}], vals=>{ state.fd.cpaEvents[i].rhythm=vals[0]; renderCpaEvents(); updateState(); }); }

function openPupilDial(s) { openDial(`ç³å­”å¾„ ${s}`, [{options:Array.from({length:17},(_,i)=>(1+i*0.5)).map(x=>({label:String(x),value:x})), selected:state.fd.stroke[`pupil${s}`], unit:'mm'}], vals=>{ state.fd.stroke[`pupil${s}`]=vals[0]; $(`#pupil${s}_display`).textContent=vals[0]; updateState(); }); }
function openMmtDial(l) { openDial('MMT', [{options:genRange(0,5,1), selected:state.fd.stroke.mmt[l]}], vals=>{ state.fd.stroke.mmt[l]=vals[0]; $(`#mmt_${l}_display`).textContent=vals[0]; updateState(); }); }

const NIHSS_ITEMS = [{id:'1a', label:'1a æ„è­˜', max:3},{id:'1b', label:'1b è³ªå•', max:2},{id:'1c', label:'1c å¾“å‘½', max:2},{id:'2', label:'2 æ³¨è¦–', max:2},{id:'3', label:'3 è¦–é‡', max:3},{id:'4', label:'4 é¡”é¢', max:3},{id:'5a', label:'5a ä¸Šè‚¢å³', max:4},{id:'5b', label:'5b ä¸Šè‚¢å·¦', max:4},{id:'6a', label:'6a ä¸‹è‚¢å³', max:4},{id:'6b', label:'6b ä¸‹è‚¢å·¦', max:4},{id:'7', label:'7 å¤±èª¿', max:2},{id:'8', label:'8 æ„Ÿè¦š', max:2},{id:'9', label:'9 è¨€èª', max:3},{id:'10', label:'10 æ§‹éŸ³', max:2},{id:'11', label:'11 æ³¨æ„', max:2}];
function renderNihss() {
  const c = $('#nihss_area'); if(!c) return; c.innerHTML = '';
  NIHSS_ITEMS.forEach(it => {
    const row = document.createElement('div'); row.style.marginBottom='10px'; const val = state.fd.stroke.nihss[it.id]||0;
    row.innerHTML = `<div style="font-size:12px;font-weight:600">${it.label}</div><div style="display:flex;gap:4px;margin-top:4px">${Array.from({length:it.max+1},(_,i)=>`<button class="nihss-btn ${val===i?'active':''}" onclick="setNihss('${it.id}',${i})">${i}</button>`).join('')}</div>`;
    c.appendChild(row);
  }); calcNihssSum();
}
function setNihss(id,v) { state.fd.stroke.nihss[id]=v; renderNihss(); updateState(); }
function calcNihssSum() { let s = Object.values(state.fd.stroke.nihss).reduce((a,b)=>a+b,0); $('#nihss_sum').textContent=s+'ç‚¹'; }

function addEmsVital() { const n=new Date(); const t=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; state.ems.vitals.push({time:t,sbp:120,dbp:80,hr:80,rr:16,spo2:98,bt:36.5,gcs:{e:4,v:5,m:6},jcs:'0'}); renderEmsVitals(); updateState(); }
function addFdVital() { const n=new Date(); const t=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; state.fd.vitals.push({time:t,sbp:120,dbp:80,hr:80,rr:16,spo2:98,bt:36.5,gcs:{e:4,v:5,m:6},jcs:'0'}); renderFdVitals(); updateState(); }
function removeVital(t,i) { if(confirm('å‰Šé™¤?')){ state[t].vitals.splice(i,1); t==='ems'?renderEmsVitals():renderFdVitals(); updateState(); } }
function renderEmsVitals() { const c=$('#ems_vitals_container'); c.innerHTML=''; state.ems.vitals.forEach((v,i)=>c.appendChild(createVitalCard('ems',i,v))); }
function renderFdVitals() { const c=$('#fd_vitals_container'); c.innerHTML=''; state.fd.vitals.forEach((v,i)=>c.appendChild(createVitalCard('fd',i,v))); }
function createVitalCard(t,idx,v) {
  const card = document.createElement('div'); card.className='vital-card';
  const gs = v.gcs.v==='T'?(v.gcs.e+v.gcs.m)+'T':(v.gcs.e+parseInt(v.gcs.v)+v.gcs.m);
  card.innerHTML = `<div class="vital-header"><input type="time" value="${v.time}" onchange="state.${t}.vitals[${idx}].time=this.value;updateState()"><button class="vital-del" onclick="removeVital('${t}',${idx})">å‰Šé™¤</button></div>
    <div class="vital-grid">
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'bp')"><div class="vital-label">BP</div><div class="vital-value">${v.sbp}/${v.dbp}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'hr')"><div class="vital-label">HR</div><div class="vital-value">${v.hr}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'rr')"><div class="vital-label">RR</div><div class="vital-value">${v.rr}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'spo2')"><div class="vital-label">SpO2</div><div class="vital-value">${v.spo2||'--'}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'bt')"><div class="vital-label">BT</div><div class="vital-value">${v.bt}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'jcs')"><div class="vital-label">JCS</div><div class="vital-value">${v.jcs}</div></div>
      <div class="vital-gcs"><div class="gcs-part" onclick="openVitalDial('${t}',${idx},'gcs_e')"><span class="lbl">E</span><span class="val">${v.gcs.e}</span></div><div class="gcs-part" onclick="openVitalDial('${t}',${idx},'gcs_v')"><span class="lbl">V</span><span class="val">${v.gcs.v}</span></div><div class="gcs-part" onclick="openVitalDial('${t}',${idx},'gcs_m')"><span class="lbl">M</span><span class="val">${v.gcs.m}</span></div><div class="gcs-sum">${gs}</div></div>
    </div>`; return card;
}

function setNow(id) { const n=new Date(); $(`#${id}`).value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; updateState(); }
function mkChip(l,m,p) {
  const e=document.createElement('span'); e.className='chip'; e.textContent=l; e.dataset.state=state[p].chips[l]||'';
  e.onclick=()=>{ let c=e.dataset.state||'',n=''; if(m==='normal')n=(c==='on'?'':'on'); else n=(c===''?'+':c==='+'?'-':''); e.dataset.state=n; if(n)state[p].chips[l]=n; else delete state[p].chips[l]; updateState(); }; return e;
}
function mountChips(id,def,p) { const b=$(id); if(!b) return; b.innerHTML=''; if(Array.isArray(def)) def.forEach(x=>b.appendChild(mkChip(x,'abn',p))); else { (def.normal||[]).forEach(x=>b.appendChild(mkChip(x,'normal',p))); (def.abn||[]).forEach(x=>b.appendChild(mkChip(x,'abn',p))); } }
function renderProcedureChips(id,its,obj) {
  const c=$(id); c.innerHTML=''; its.forEach(it=>{ const chip=document.createElement('div'); chip.className='chip'; chip.textContent=it; if(obj[it]) chip.dataset.state='proc'; chip.onclick=()=>{ obj[it]=!obj[it]; chip.dataset.state=obj[it]?'proc':''; if(id==='ems_procedures'&&it==='é…¸ç´ æŠ•ä¸')$('#ems_o2_amount').style.display=obj[it]?'block':'none'; updateState(); }; c.appendChild(chip); });
}
function setupExamTabs(p) {
  $$(`#${p}_examTabs .exam-tab`).forEach(tab=>{ tab.onclick=()=>{ $$(`#${p}_examTabs .exam-tab`).forEach(t=>t.classList.remove('active')); tab.classList.add('active'); state[p].exam_tab=tab.dataset.exam; const card=tab.closest('.card'); card.querySelectorAll('.exam-pane').forEach(pn=>pn.classList.remove('active')); card.querySelector(`.exam-pane[data-pane="${tab.dataset.exam}"]`).classList.add('active'); if(tab.dataset.exam==='cpa') setCpaVitalDefaults(); updateState(); }; });
}
function setCpaVitalDefaults() { if(!confirm('CPAãƒ¢ãƒ¼ãƒ‰ï¼šãƒã‚¤ã‚¿ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return; [state.ems, state.fd].forEach(s=>s.vitals.forEach(v=>{ v.sbp=0;v.dbp=0;v.hr=0;v.rr=0;v.spo2=0;v.jcs='300';v.gcs={e:1,v:1,m:1}; })); renderEmsVitals(); renderFdVitals(); updateState(); }

function bindMemos() {
  const b=(id,o,k)=>{ const e=$(id); if(e){ e.value=o[k]||''; e.oninput=()=>{o[k]=e.value;updateState();}; } };
  ['head','resp','card','abd','limb','neuro'].forEach(k=>b(`#memo-ems-gen-${k}`,state.ems.memos.general,k));
  ['head','neck','chest','abd','pelvis','limb'].forEach(k=>b(`#memo-ems-tra-${k}`,state.ems.memos.trauma,k));
  b('#memo-ems-cpa',state.ems.memos.cpa,'memo'); b('#memo-ems-str',state.ems.memos.stroke,'memo');
  ['head','resp','card','abd','limb','neuro'].forEach(k=>b(`#memo-fd-gen-${k}`,state.fd.memos.general,k));
  ['head','neck','chest','abd','pelvis','limb'].forEach(k=>b(`#memo-fd-tra-${k}`,state.fd.memos.trauma,k));
  ['cn','eye','motor','reflex','higher'].forEach(k=>{ const e=$(`#memo-fd-str-${k}`); if(e){ e.value=state.fd.memos.stroke[k]||''; e.oninput=()=>{state.fd.memos.stroke[k]=e.value;updateState();}; } });
  ['body','head','trunk'].forEach(k=>b(`#memo-fd-cpa-${k}`,state.fd.memos.cpa,k));
}

function toggleAbg(){ state.fd.abg_type=$('#fd_abg_type').value; $('#abg_area').style.display=state.fd.abg_type?'block':'none'; updateState(); }
function addAbgSet(){ ABG_ITEMS.forEach(it=>{ if(!state.fd.abg_data.some(x=>x.item===it.item)) state.fd.abg_data.push({item:it.item, unit:it.unit, val:it.normal}); }); renderAbgPills(); updateState(); }
function renderAbgPills() { const c=$('#abg_pills'); c.innerHTML=''; state.fd.abg_data.forEach((r,i)=>{ const p=document.createElement('div'); p.className='labpill'; p.innerHTML=`<label>${r.item}</label><span style="color:var(--brand);font-weight:600" onclick="openAbgDial(${i})">${r.val}</span><span class="unit">${r.unit}</span><button onclick="state.fd.abg_data.splice(${i},1);renderAbgPills();updateState()">Ã—</button>`; c.appendChild(p); }); }
function toggleExam(t){ state.fd.exams[t]=$(`#exam_${t}`).checked; if(t==='bs')$('#exam_bs_area').style.display=state.fd.exams[t]?'block':'none'; else $(`#exam_${t}_txt`).style.display=state.fd.exams[t]?'block':'none'; updateState(); }

function addProblem(){ const i=$('#new_problem'),t=i.value.trim(); if(t){state.problems.push(t);i.value='';renderProblems();updateState();} }
function renderProblems(){ $('#problems').innerHTML=state.problems.map((p,i)=>`<div class="problem-item"><span>#${i+1} ${p}</span><button class="del-btn" onclick="state.problems.splice(${i},1);renderProblems();updateState()">å‰Šé™¤</button></div>`).join(''); }

let selectedRegion = 'é¹¿å…å³¶';
function renderHospitalChips() {
  const c=$('#destination_chips'); c.innerHTML='';
  const tabs = document.createElement('div'); tabs.style.cssText='display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--line)';
  Object.keys(state.hospitals).forEach(r=>{ const t=document.createElement('div'); t.style.cssText=`padding:6px 12px;border-radius:16px;font-size:13px;cursor:pointer;${selectedRegion===r?'background:var(--brand);color:#fff':'background:var(--chip)'}`; t.textContent=r; t.onclick=()=>{selectedRegion=r;renderHospitalChips();}; tabs.appendChild(t); });
  c.appendChild(tabs);
  const hBox = document.createElement('div'); hBox.style.cssText='display:flex;flex-wrap:wrap;gap:8px';
  (state.hospitals[selectedRegion]||[]).forEach(h=>{ const ch=document.createElement('div'); ch.className='chip'+(state.destination.hospital===h?' active':''); ch.textContent=h; ch.onclick=()=>{ state.destination.hospital=(state.destination.hospital===h?'':h); if(state.destination.hospital) {$('#destination_custom').value=''; state.destination.custom='';} renderHospitalChips(); updateState(); }; hBox.appendChild(ch); });
  c.appendChild(hBox);
}

function updateState() {
  const f=state.fd, e=state.ems;
  state.request.type=$('#request_type').value; state.request.detail=$('#request_detail').value; state.request.time=$('#request_time').value;
  state.patient={history:$('#patient_history').value, medication:$('#patient_medication').value, allergy:$('#patient_allergy').value, lastMeal:$('#last_meal_time').value, hospital:$('#patient_hospital').value};
  state.heli={takeoff:$('#heli_takeoff').value, lz_landing:$('#heli_lz_landing').value, fd_contact:$('#fd_contact').value, turn_type:$('#turn_type').value, transport_takeoff:$('#transport_takeoff').value, hospital_arrival:$('#hospital_arrival').value};
  e.aware=$('#ems_aware').value; e.arrival=$('#ems_arrival').value; e.contact=$('#ems_contact').value; e.lz=$('#ems_lz').value; e.o2_flow=$('#ems_o2_flow').value; e.procedures_detail=$('#ems_procedures_detail').value;
  f.bs=$('#fd_bs').value; f.exam_detail=$('#fd_exam_detail').value; f.procedure_detail=$('#fd_procedure_detail').value; f.drug_detail=$('#fd_drug_detail').value;
  ['us','ecg','fast','efast'].forEach(k=>f.exam_texts[k]=$(`#exam_${k}_txt`).value);
  if($('#plrL')){ f.stroke.plrL=$('#plrL').value; f.stroke.plrR=$('#plrR').value; f.stroke.gaze=$('#str_gaze').value; f.stroke.nyst=$('#str_nyst').value; f.stroke.btr=$('#str_btr').value; f.stroke.ptr=$('#str_ptr').value; f.stroke.babinski=$('#str_babinski').checked; f.stroke.chaddock=$('#str_chaddock').checked; f.stroke.nihssMemo=$('#nihss_memo')?.value||''; }
  state.consideration=$('#consideration').value; state.destination.custom=$('#destination_custom').value; state.destination.reason=$('#selection_reason').value;
  const h = state.destination.custom || state.destination.hospital; $('#destination_display').style.display = h ? 'block' : 'none'; $('#destination_selected').textContent = h;
  render(); localStorage.setItem('heliRecordV33', JSON.stringify(state));
}

function render() { $('#outText').textContent = generateReport(); }
function fmtFinding(l, s) { if(s==='on')return l; if(s==='+')return `${l}(+)`; if(s==='-')return `${l}(-)`; return null; }
function extractFindings(d, c) { let a=[]; (Array.isArray(d)?d:(d.normal||[]).concat(d.abn||[])).forEach(l=>{ if(c[l]){let s=fmtFinding(l,c[l]);if(s)a.push(s);} }); return a.join('ã€'); }

function generateReport() {
  let r = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€ç—…é™¢å‰åŒ»ç™‚æ´»å‹•è¨˜éŒ²\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nã€è¦è«‹æƒ…å ±ã€‘\nè¦è«‹æ–¹æ³•ï¼š'+(state.request.type||'ï¼ˆæœªé¸æŠï¼‰')+'\n';
  if(state.request.time) r+=`è¦è«‹æ™‚åˆ»ï¼š${state.request.time}\n`;
  if(state.request.detail) r+=`è¦è«‹å†…å®¹ï¼š${state.request.detail}\n`;
  r+='\nã€æ‚£è€…æƒ…å ±ã€‘\næ—¢å¾€æ­´ï¼š'+state.patient.history+'\nå¸¸ç”¨è–¬ï¼š'+state.patient.medication+'\nã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š'+state.patient.allergy+'\nã‹ã‹ã‚Šã¤ã‘ï¼š'+state.patient.hospital+'\n';
  r+='\nã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã€‘\né›¢é™¸ï¼š'+state.heli.takeoff+' / LZç€ï¼š'+state.heli.lz_landing+' / æ¥è§¦ï¼š'+state.heli.fd_contact+' / æ´»å‹•ï¼š'+state.heli.turn_type+'\n';
  r+='\nã€æ•‘æ€¥éšŠã€‘\n'; e=state.ems; e.vitals.forEach(v=>{ let gs=v.gcs.v==='T'?(v.gcs.e+v.gcs.m)+'T':(v.gcs.e+parseInt(v.gcs.v)+v.gcs.m); r+=`[${v.time}] ${v.sbp}/${v.dbp}, HR${v.hr}, SpO2 ${v.spo2||'--'}%, GCS${gs}, JCS${v.jcs}\n`; });
  r+='æ‰€è¦‹ï¼š'+(e.exam_tab==='general'?['head','resp','card','abd','limb','neuro'].map(k=>extractFindings(EMS_GEN_GROUPS[k],e.chips)).filter(Boolean).join('ã€'):extractFindings(EMS_TRA_GROUPS[e.exam_tab]||EMS_STR_GROUPS[e.exam_tab]||EMS_CPA_GROUPS[e.exam_tab],e.chips))+'\n';
  r+='\nã€ãƒ‰ã‚¯ã‚¿ãƒ¼ã€‘\n'; f=state.fd; f.vitals.forEach(v=>{ let gs=v.gcs.v==='T'?(v.gcs.e+v.gcs.m)+'T':(v.gcs.e+parseInt(v.gcs.v)+v.gcs.m); r+=`[${v.time}] ${v.sbp}/${v.dbp}, HR${v.hr}, SpO2 ${v.spo2||'--'}%, GCS${gs}, JCS${v.jcs}\n`; });
  
  // èº«ä½“æ‰€è¦‹ã®è¿½åŠ 
  r+='æ‰€è¦‹ï¼š'+(f.exam_tab==='general'?['head','resp','card','abd','limb','neuro'].map(k=>extractFindings(FD_GEN_GROUPS[k],f.chips)).filter(Boolean).join('ã€'):extractFindings(FD_TRA_GROUPS[f.exam_tab]||FD_STR_GROUPS[f.exam_tab]||FD_CPA_GROUPS[f.exam_tab],f.chips))+'\n';
  if(f.exam_tab==='stroke'){ r+=`ç³å­”L${f.stroke.pupilL} R${f.stroke.pupilR}, å¯¾å…‰L${f.stroke.plrL} R${f.stroke.plrR}, MMT(${f.stroke.mmt.ru},${f.stroke.mmt.lu},${f.stroke.mmt.rl},${f.stroke.mmt.ll})\n`; }
  if(f.exam_tab==='cpa'){ f.cpaEvents.forEach((ev,i)=>r+=`å¿ƒåœæ­¢${i+1}ï¼š${ev.arrestTime} ${ev.rhythm}, ROSC${ev.roscTime}\n`); }
  
  r+='\nã€è©•ä¾¡ã€‘\n'+state.problems.map((p,i)=>'#'+(i+1)+' '+p).join('\n')+'\nè€ƒå¯Ÿï¼š'+state.consideration+'\n\nã€æ¬é€å…ˆã€‘\n'+(state.destination.custom||state.destination.hospital||'ï¼ˆæœªé¸æŠï¼‰')+'\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nè¨˜éŒ²ä½œæˆï¼š'+new Date().toLocaleString(); return r;
}

function saveData() { const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`heli_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
function loadData() { const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=e=>{ const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=ev=>{ try{state=JSON.parse(ev.target.result);restoreUI();}catch(e){alert('èª­è¾¼ã‚¨ãƒ©ãƒ¼');} }; r.readAsText(f); } }; i.click(); }
function resetData() { if(confirm('ãƒªã‚»ãƒƒãƒˆ?')){ localStorage.removeItem('heliRecordV33'); location.reload(); } }

function restoreUI() {
  const f=state.fd, e=state.ems;
  $('#request_type').value=state.request.type; $('#request_detail').value=state.request.detail; $('#request_time').value=state.request.time;
  $('#patient_history').value=state.patient.history; $('#patient_medication').value=state.patient.medication; $('#patient_allergy').value=state.patient.allergy; $('#last_meal_time').value=state.patient.lastMeal; $('#patient_hospital').value=state.patient.hospital;
  $('#heli_takeoff').value=state.heli.takeoff; $('#heli_lz_landing').value=state.heli.lz_landing; $('#fd_contact').value=state.heli.fd_contact; $('#turn_type').value=state.heli.turn_type; $('#transport_takeoff').value=state.heli.transport_takeoff; $('#hospital_arrival').value=state.heli.hospital_arrival;
  $('#ems_aware').value=e.aware; $('#ems_arrival').value=e.arrival; $('#ems_contact').value=e.contact; $('#ems_lz').value=e.lz; $('#ems_o2_flow').value=e.o2_flow; $('#ems_procedures_detail').value=e.procedures_detail;
  $('#fd_bs_display').textContent=f.bs; $('#fd_abg_type').value=f.abg_type; toggleAbg();
  ['us','ecg','fast','efast'].forEach(k=>{ $(`#exam_${k}`).checked=f.exams[k]; $(`#exam_${k}_txt`).value=f.exam_texts[k]; toggleExam(k); });
  if($('#plrL')){ $('#pupilL_display').textContent=f.stroke.pupilL; $('#pupilR_display').textContent=f.stroke.pupilR; $('#plrL').value=f.stroke.plrL; $('#plrR').value=f.stroke.plrR; $('#str_gaze').value=f.stroke.gaze; $('#str_nyst').value=f.stroke.nyst; $('#mmt_ru_display').textContent=f.stroke.mmt.ru; $('#mmt_lu_display').textContent=f.stroke.mmt.lu; $('#mmt_rl_display').textContent=f.stroke.mmt.rl; $('#mmt_ll_display').textContent=f.stroke.mmt.ll; $('#str_btr').value=f.stroke.btr; $('#str_ptr').value=f.stroke.ptr; $('#str_babinski').checked=f.stroke.babinski; $('#str_chaddock').checked=f.stroke.chaddock; if($('#nihss_memo')) $('#nihss_memo').value = f.stroke.nihssMemo; renderNihss(); }
  $('#consideration').value=state.consideration; $('#destination_custom').value=state.destination.custom; $('#selection_reason').value=state.destination.reason;
  renderEmsVitals(); renderFdVitals(); renderHospitalChips(); renderCpaEvents(); renderAbgPills(); renderProblems(); bindMemos();
  renderProcedureChips('ems_procedures', e.procedures_items, e.procedures); renderProcedureChips('fd_procedures', f.procedures_items, f.procedures); renderProcedureChips('fd_drugs', f.drugs_items, f.drugs);
  render();
}

function init() {
  const saved = localStorage.getItem('heliRecordV33'); if(saved) try{state=JSON.parse(saved);}catch(e){}
  if(state.ems.vitals.length===0) addEmsVital(); if(state.fd.vitals.length===0) addFdVital();
  [['#ems-gen-head',EMS_GEN_GROUPS.head],['#ems-gen-resp',EMS_GEN_GROUPS.resp],['#ems-gen-card',EMS_GEN_GROUPS.card],['#ems-gen-abd',EMS_GEN_GROUPS.abd],['#ems-gen-limb',EMS_GEN_GROUPS.limb],['#ems-gen-neuro',EMS_GEN_GROUPS.neuro],['#ems-tra-head',EMS_TRA_GROUPS.head],['#ems-tra-neck',EMS_TRA_GROUPS.neck],['#ems-tra-chest',EMS_TRA_GROUPS.chest],['#ems-tra-abd',EMS_TRA_GROUPS.abd],['#ems-tra-pelvis',EMS_TRA_GROUPS.pelvis],['#ems-tra-limb',EMS_TRA_GROUPS.limb],['#ems-cpa-rhythm',EMS_CPA_GROUPS.rhythm],['#ems-cpa-witness',EMS_CPA_GROUPS.witness],['#ems-cpa-airway',EMS_CPA_GROUPS.airway],['#ems-cpa-circulation',EMS_CPA_GROUPS.circulation],['#ems-cpa-chest',EMS_CPA_GROUPS.chest],['#ems-str-conscious',EMS_STR_GROUPS.conscious],['#ems-str-face',EMS_STR_GROUPS.face],['#ems-str-motor',EMS_STR_GROUPS.motor],['#ems-str-other',EMS_STR_GROUPS.other]].forEach(x=>mountChips(x[0],x[1],'ems'));
  [['#fd-gen-head',FD_GEN_GROUPS.head],['#fd-gen-resp',FD_GEN_GROUPS.resp],['#fd-gen-card',FD_GEN_GROUPS.card],['#fd-gen-abd',FD_GEN_GROUPS.abd],['#fd-gen-limb',FD_GEN_GROUPS.limb],['#fd-gen-neuro',FD_GEN_GROUPS.neuro],['#fd-tra-head',FD_TRA_GROUPS.head],['#fd-tra-neck',FD_TRA_GROUPS.neck],['#fd-tra-chest',FD_TRA_GROUPS.chest],['#fd-tra-abd',FD_TRA_GROUPS.abd],['#fd-tra-pelvis',FD_TRA_GROUPS.pelvis],['#fd-tra-limb',FD_TRA_GROUPS.limb],['#fd-str-cn',FD_STR_GROUPS.cn],['#fd-str-higher',FD_STR_GROUPS.higher]].forEach(x=>mountChips(x[0],x[1],'fd'));
  setupExamTabs('ems'); setupExamTabs('fd'); bindMemos(); restoreUI();
  $('#copyOut').onclick=()=>{ navigator.clipboard.writeText($('#outText').textContent); const b=$('#copyOut'); b.textContent='âœ“ å®Œäº†'; setTimeout(()=>b.textContent='ğŸ“‹ ã‚³ãƒ”ãƒ¼',1500); };
}
init();
// PWA Service Worker ç™»éŒ²ãƒ­ã‚¸ãƒƒã‚¯
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then((reg) => {
      console.log('Service Worker ç™»éŒ²å®Œäº†:', reg.scope);
    }).catch((err) => {
      console.log('Service Worker ç™»éŒ²å¤±æ•—:', err);
    });
  });
}
</script>
</body>
</html>